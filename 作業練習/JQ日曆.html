<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <style>
        .unshow {
            color: #9ca1a8;
            background-color: #bebebe;
        }

        td {
            height: 100px;
            width: 10%;
            text-align: start;
        }

        .btn-block {
            background-color: rgba(255, 255, 255, 0);
        }

        .buttondate:hover {
            background-color: rgba(220, 20, 60, 0);
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        li {
            font-size: 12px;
            padding: 0 5px;
        }

        li:hover {
            background-color: crimson !important;
            color: white;
            font-weight: bolder;
        }

        #map {
            width: 100%;
            height: 200px;
        }

        #limap {
            width: 100%;
            height: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row mt-2">
            <div class="col-2">
                <button type="button" class="btn btn-light" id="btnlast">
                    < </button>
            </div>

            <div class="col-8 text-center">
                <span class="text-center" id="mouths">2018</span>
                <button type="button" class="btn buttondate rounded-0" data-toggle="modal" data-target="#asd">行事曆</button>

            </div>
            <div class="col-2 text-right">
                <button type="button" class="btn btn-light" id="btnnext">
                    >
                </button>
            </div>

        </div>
        <div class="row">
            <div class="col">
                <table class="table table-bordered text-center" id="dateZone">
                    <thead>
                        <tr>
                            <th>SUN</th>
                            <th>MON</th>
                            <th>TUE</th>
                            <th>WED</th>
                            <th>THU</th>
                            <th>FRI</th>
                            <th>SAT</th>
                        </tr>
                    </thead>
                    <tbody id="dateTable">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="asd" class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">新增事件</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="userday">日期：</label>
                                <input type="date" class="form-control" name="userday" id="userday" aria-describedby="helpId">
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="fromHR">開始時間：</label>
                                    <input type="time" class="form-control" name="fromHR" id="fromHR" aria-describedby="helpId">
                                </div>
                                <div class="col">
                                    <label for="toHR">結束時間：</label>
                                    <input type="time" class="form-control" name="toHR" id="toHR" aria-describedby="helpId">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="subject" class="col-form-label">事件 :</label>
                                <textarea class="form-control" id="subject"></textarea>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="useradress">地址 :</label>
                                    <input type="input" class="form-control" name="useraddress" id="useraddress" aria-describedby="helpId" placeholder="請在地圖上點選."
                                        disabled>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <div class="col">
                            <div class="form-group">
                                <label for="usercolor">顏色 :</label>
                                <input type="color" class="form-control" name="usercolor" id="usercolor" aria-describedby="helpId" placeholder="為這資料給個顏色">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="datainput">確認</button>
                    </div>
                    <div id="map">
                    </div>
                </div>
            </div>
        </div>

        <div id="lidata" class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">編輯事件</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="liuserday">日期：</label>
                                <input type="input" class="form-control" name="liuserday" id="liuserday" aria-describedby="helpId" disabled>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="lifromHR">開始時間：</label>
                                    <input type="time" class="form-control" name="lifromHR" id="lifromHR" aria-describedby="helpId">
                                </div>
                                <div class="col">
                                    <label for="litoHR">結束時間：</label>
                                    <input type="time" class="form-control" name="litoHR" id="litoHR" aria-describedby="helpId">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="lisubject" class="col-form-label">事件 :</label>
                                <textarea class="form-control" id="lisubject"></textarea>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="liaddress">地址 :</label>
                                    <input type="input" class="form-control" name="liaddress" id="liaddress" aria-describedby="helpId" placeholder="請在地圖上點選."
                                        disabled>
                                </div>

                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <div class="col">
                            <div class="form-group">
                                <label for="liusercolor">顏色 :</label>
                                <input type="color" class="form-control" name="liusercolor" id="liusercolor" aria-describedby="helpId" placeholder="為這資料給個顏色">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="lichange">修改</button>
                        <button type="button" class="btn btn-danger" id="liremove">刪除</button>
                    </div>
                    <div id="limap"></div>
                </div>
            </div>
        </div>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjYa2lWEDFEOGah0x1xBcIc-km4rg7B3Y&callback=initMap" async
            defer></script>
        <script type="text/javascript">
            var map = null;
            var marker = null;
            var center = { lat: 24.7571075, lng: 120.952429 };
            window.onload = function () {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: center,
                    zoom: 15
                });

                map.addListener('click', function (e) {//點擊地圖放上地標&座標
                    map.setCenter(e.latLng);

                    if (marker != null) {
                        marker.setMap(null);
                        marker = null;
                    }
                    marker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        title: e.latLng.toString()
                    });
                    var geocoder = new google.maps.Geocoder();
                    // 傳入 latLng 資訊至 geocoder.geocode
                    geocoder.geocode({ 'latLng': marker.position }, function (results, status) {
                        if (status === google.maps.GeocoderStatus.OK) {
                            // 如果有資料就會回傳
                            if (results) {
                                console.log(results[0].formatted_address);
                                document.getElementById("useraddress").value = results[0].formatted_address;
                            }
                        }
                        // 經緯度資訊錯誤
                        else {
                            alert("Reverse Geocoding failed because: " + status);
                        }
                    });
                });
            }
            var month = new Array();
            month[0] = "January";
            month[1] = "February";
            month[2] = "March";
            month[3] = "April";
            month[4] = "May";
            month[5] = "June";
            month[6] = "July";
            month[7] = "August";
            month[8] = "September";
            month[9] = "October";
            month[10] = "November";
            month[11] = "December";
            var today = new Date();
            //console.log(today);
            var thismonth = today.getMonth();
            //console.log(thismonth);
            $("#mouths").html(month[thismonth] + " " + today.getFullYear());


            var drawPicker = function (x) {
                var getmonthdays = function (x) {//月最後一天
                    var days = new Date(x);
                    var years = days.getFullYear();
                    var mouths = days.getMonth() + 1;
                    var todays = new Date(years, mouths, 0);
                    return todays;
                    //console.log(todays);//Mon Apr 30 2018 00:00:00 GMT+0800 (台北標準時間)
                }
                var getfirstdays = function (x) {//這個月第一天是星期幾
                    var days = new Date(x);
                    days.setDate(1);//將日期設為一號
                    var todays = days.getDay();
                    return todays;
                    //console.log(todays);//0
                }
                var getweek = function (x) {
                    var days = new Date(x);
                    var daysmouth = days.getMonth();
                    var firstday = getfirstdays(x);
                    var lastday = getmonthdays(x);
                    if (daysmouth == 1 && firstday == 0 && lastday % 7 == 0) {
                        return 4
                    } else {
                        if (firstday == 5 && lastday % 7 == 3) {
                            return 6;
                        } else if (firstday == 6) {
                            return 6;
                        } else {
                            return 5;
                        }
                    }
                }
                var days = new Date(x);
                var monthdays = getmonthdays(x);
                var firstdays = getfirstdays(x);
                var week = getweek(x);
                days.setDate(1);
                var k = 0, a = 0, b = 0, c = 0;
                for (var i = 0; i < week; i++) {
                    var newRow = $("<tr>");
                    for (var j = 0; j < 7; j++) {

                        var newDate = $("<td>");
                        
                        if (a < firstdays) {
                            a++;
                            var tempDate = new Date(days);
                            tempDate.setDate(a - firstdays);
                            newDate
                            .addClass("unshow")
                            .text(tempDate.getDate());
                        }
                        else if (b < monthdays.getDate()) {
                            b++;
                            newDate
                            .addClass("show")
                            .text(new Date(days).getDate());
                            days.setDate(b + 1);
                        }
                        else if (c < (6 - monthdays.getDay())) {
                            c++;
                            newDate
                            .addClass("unshow")
                            .text(new Date(days).getDate());
                            days.setDate(days.getDate() + 1);
                            //console.log(days);
                        }
                        var ul = $("<ul>").prop("id",month[new Date(days).getMonth()] + newDate.text());
                        newDate.append(ul);
                        newRow.append(newDate);
                    }
                    $("#dateTable").append(newRow);
                }
            }
            drawPicker(today);

            $("#btnlast").click(function () {
                $("#dateTable").html("");
                thismonth--;
                var newdate = new Date(2018, thismonth, 15);
                $("#mouths").text(month[newdate.getMonth()] + " " + newdate.getFullYear());
                drawPicker(newdate);
                lidata();
            });
            $("#btnnext").click(function () {
                $("#dateTable").html("");
                thismonth++;
                var newdate = new Date(2018, thismonth, 15);
                $("#mouths").text(month[newdate.getMonth()] + " " + newdate.getFullYear());
                drawPicker(newdate);
                lidata();
            });
            //資料結構
            $("#datainput").click(function () {
                schedule();
            });

            var schedule = function () {
                function _uuid() {
                    var d = Date.now();
                    if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
                        d += performance.now(); //use high-precision timer if available
                    }
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = (d + Math.random() * 16) % 16 | 0;
                        d = Math.floor(d / 16);
                        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                    });
                }
                var key = _uuid();
                var userday = new Date($("#userday").val());
                var scheduleItem = {
                    userday: month[userday.getMonth()] + userday.getDate(),
                    fromHR: $("#fromHR").val(),//開始時間
                    toHR: $("#toHR").val(),//結束時間
                    subject: $("#subject").val(),//行事曆主題
                    color: $("#usercolor").val(),//使用者自訂色彩
                    address: $("#useraddress").val()
                };
                var obj = JSON.stringify(scheduleItem);
                localStorage.setItem(key, obj);
                console.log("存檔成功");
                $("#dateTable").html("");
                var newdate = new Date(2018, thismonth, 15);
                drawPicker(newdate);
                lidata();
            }

            var finallydata = function () {
                var li = event.srcElement;
                $("#liuserday").val(JSON.parse(localStorage[li.id]).userday);
                $("#lifromHR").val(JSON.parse(localStorage[li.id]).fromHR);
                $("#litoHR").val(JSON.parse(localStorage[li.id]).toHR);
                $("#lisubject").val(JSON.parse(localStorage[li.id]).subject);
                $("#liusercolor").val(JSON.parse(localStorage[li.id]).color);
                $("#liaddress").val(JSON.parse(localStorage[li.id]).address);
                var liadress = $("#liaddress").val();

                var geocoder = new google.maps.Geocoder();
                var ReadLatlng = { lat: null, lng: null };
                geocoder.geocode({ address: liadress }, function (result, status) {
                    if (status == google.maps.GeocoderStatus.OK) {

                        var location = result[0].geometry.location;
                        var limap = new google.maps.Map(document.getElementById('limap'), {
                            center: { lat: location.lat(), lng: location.lng() },
                            zoom: 15
                        });
                        var markerr = new google.maps.Marker({//放上地標
                            position: { lat: location.lat(), lng: location.lng() },
                            map: limap,
                            title: liadress
                        });
                    } else {
                        alert('解析失敗!回傳狀態為：' + status);
                    }
                });
                $("#lichange").click(function () {
                    var scheduleItem = {
                        userday: JSON.parse(localStorage[li.id]).userday,
                        fromHR: $("#lifromHR").val(),//開始時間
                        toHR: $("#litoHR").val(),//結束時間
                        subject: $("#lisubject").val(),//行事曆主題
                        color: $("#liusercolor").val(),//使用者自訂色彩
                        address: $("#liaddress").val()
                    };
                    var obj = JSON.stringify(scheduleItem);
                    localStorage.setItem(li.id, obj);
                    console.log("修改成功");
                    $("#dateTable").html("");
                    var newdate = new Date(2018, thismonth, 15);
                    drawPicker(newdate);
                    lidata();
                });
                $("#liremove").click(function () {
                    localStorage.removeItem(li.id);
                    console.log("刪除成功");
                    $("#dateTable").html("");
                    var newdate = new Date(2018, thismonth, 15);
                    drawPicker(newdate);
                    lidata();
                });
            }

            var lidata = function () {
                for (var item in localStorage) {
                    var newschedule = JSON.parse(localStorage[item]);
                    var z = $("#"+newschedule.userday);
                    if (z == null) {

                    } else if (z.attr("id") == newschedule.userday) {
                        console.log(z);
                        var li=$("<li></li>")
                        .attr("id",item)
                        .addClass("myli rounded")
                        .attr("data-toggle", "modal")
                        .attr("data-target", "#lidata")
                        .attr("onclick", "finallydata()")
                        .css("background-color",newschedule.color)
                        .text(newschedule.fromHR + " " + newschedule.subject.toString());
                        z.append(li);
                        console.log(li);
                    }
                }
            }
            lidata();
            var scheduleItem = {
                key: "",//行事曆鍵值
                userday: "",
                fromHR: "",//開始時間
                toHR: "",//結束時間
                subject: "",//行事曆主題
                color: "",//使用者自訂色彩
                address: ""
            };

        </script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</body>

</html>